{% extends "base.html" %}

{% block title %}Analytics Dashboard - Personal Finance Analytics{% endblock %}

{% block head %}
{{ super() }}
<style>
    .chart-container {
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        min-height: 350px;
        display: flex;
        flex-direction: column;
    }
    
    /* Special handling for sunburst container */
    .chart-container:has(#sunburstChart) {
        height: auto;
        max-height: 600px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    #sunburstChart {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    #sunburstChart svg {
        display: block;
        margin: 0 auto;
    }
    
    .chart-container canvas {
        flex: 1;
        max-height: 300px !important;
    }
    
    /* Ensure legends don't overflow */
    .chart-container {
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .chart-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .chart-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .chart-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.12);
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .insight-card {
        background: #f8f9fa;
        border-left: 4px solid #36A2EB;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .chart-export {
        background: none;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .chart-export:hover {
        background: #f8f9fa;
        border-color: #36A2EB;
        color: #36A2EB;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-graph-up text-primary me-3"></i>Analytics Dashboard
            </h1>
            <p class="text-muted">Gain insights into your spending patterns and financial habits</p>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="monthFilter" class="form-label">Month</label>
                <select id="monthFilter" class="form-select">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Year</label>
                <select id="yearFilter" class="form-select">
                    {% for year in range(2020, 2030) %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="updateCharts()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Update Charts
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="exportData()">
                    <i class="bi bi-download me-2"></i>Export Report
                </button>
            </div>
        </div>
    </div>
    
    <!-- Summary Stats -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card">
                <p class="stat-label">Total Spent This Month</p>
                <h2 class="stat-value" id="totalSpent">$0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <p class="stat-label">Average Daily Spending</p>
                <h2 class="stat-value" id="avgDaily">$0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <p class="stat-label">Most Expensive Category</p>
                <h2 class="stat-value" id="topCategory">-</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <p class="stat-label">Transactions This Month</p>
                <h2 class="stat-value" id="transactionCount">0</h2>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <h3 class="chart-title">
                    Expense Breakdown by Category
                    <button class="chart-export" onclick="exportChart('categoryPieChart')">
                        <i class="bi bi-download"></i>
                    </button>
                </h3>
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <canvas id="categoryPieChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h3 class="chart-title">
                    12-Month Spending Trend
                    <button class="chart-export" onclick="exportChart('trendLineChart')">
                        <i class="bi bi-download"></i>
                    </button>
                </h3>
                <canvas id="trendLineChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h3 class="chart-title">
                    Daily Spending Pattern
                    <button class="chart-export" onclick="exportChart('dailyBarChart')">
                        <i class="bi bi-download"></i>
                    </button>
                </h3>
                <canvas id="dailyBarChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container">
                <h3 class="chart-title">Top 5 Categories (Year)</h3>
                <canvas id="topCategoriesChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Charts Row 3 -->
    <div class="row">
        <div class="col-md-12">
            <div class="chart-container">
                <h3 class="chart-title">Category & Subcategory Breakdown</h3>
                <div id="sunburstChart" style="height: 500px; max-width: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center;"></div>
            </div>
        </div>
    </div>
    
    <!-- Payment Methods and Insights -->
    <div class="row">
        <div class="col-md-4">
            <div class="chart-container">
                <h3 class="chart-title">Payment Methods</h3>
                <canvas id="paymentMethodChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        <div class="col-md-8">
            <div class="chart-container">
                <h3 class="chart-title">
                    <i class="bi bi-lightbulb text-warning me-2"></i>Insights & Recommendations
                </h3>
                <div id="insights">
                    <div class="insight-card">
                        <h6><i class="bi bi-info-circle me-2"></i>Loading insights...</h6>
                        <p class="mb-0 text-muted">Analyzing your spending patterns...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Chart instances
let categoryPieChart, trendLineChart, dailyBarChart, topCategoriesChart, paymentMethodChart;

// Initialize filters with current month/year
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    document.getElementById('monthFilter').value = now.getMonth() + 1;
    document.getElementById('yearFilter').value = now.getFullYear();
    
    // Load all charts
    updateCharts();
});

function updateCharts() {
    const month = document.getElementById('monthFilter').value;
    const year = document.getElementById('yearFilter').value;
    
    // Show loading spinners
    document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'block');
    
    // Update all charts
    updateCategoryPieChart(month, year);
    updateTrendLineChart();
    updateDailyBarChart(month, year);
    updateTopCategories(year);
    updatePaymentMethods(month, year);
    updateSunburstChart(month, year);
    updateStats(month, year);
}

function updateCategoryPieChart(month, year) {
    fetch(`/analytics/api/expense-by-category?month=${month}&year=${year}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (categoryPieChart) categoryPieChart.destroy();
            
            // Check if we have data
            if (!data.labels || data.labels.length === 0) {
                document.querySelector('#categoryPieChart').previousElementSibling.innerHTML = 
                    '<div class="alert alert-info">No expense data for this period</div>';
                return;
            }
            
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            categoryPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 8,
                                font: { size: 10 },
                                boxWidth: 10,
                                usePointStyle: true,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.slice(0, 8).map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: label.length > 15 ? label.substring(0, 15) + '...' : label,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Hide loading spinner
            document.querySelector('#categoryPieChart').previousElementSibling.style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading category chart:', error);
            document.querySelector('#categoryPieChart').previousElementSibling.innerHTML = 
                `<div class="alert alert-warning">Error: ${error.message}</div>`;
        });
}

function updateTrendLineChart() {
    fetch('/analytics/api/monthly-trend')
        .then(response => response.json())
        .then(data => {
            if (trendLineChart) trendLineChart.destroy();
            
            const ctx = document.getElementById('trendLineChart').getContext('2d');
            trendLineChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        });
}

function updateDailyBarChart(month, year) {
    fetch(`/analytics/api/daily-spending?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            if (dailyBarChart) dailyBarChart.destroy();
            
            const ctx = document.getElementById('dailyBarChart').getContext('2d');
            dailyBarChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        });
}

function updateTopCategories(year) {
    fetch(`/analytics/api/top-categories?year=${year}`)
        .then(response => response.json())
        .then(data => {
            if (topCategoriesChart) topCategoriesChart.destroy();
            
            const ctx = document.getElementById('topCategoriesChart').getContext('2d');
            topCategoriesChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        });
}

function updatePaymentMethods(month, year) {
    fetch(`/analytics/api/payment-methods?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            if (paymentMethodChart) paymentMethodChart.destroy();
            
            const ctx = document.getElementById('paymentMethodChart').getContext('2d');
            paymentMethodChart = new Chart(ctx, {
                type: 'polarArea',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                font: { size: 10 },
                                padding: 5,
                                boxWidth: 10,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            return {
                                                text: label.length > 12 ? label.substring(0, 12) + '...' : label,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        });
}

function updateSunburstChart(month, year) {
    fetch(`/analytics/api/category-breakdown?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            // Clear previous chart
            d3.select("#sunburstChart").selectAll("*").remove();
            
            // Create hierarchical data
            const hierarchyData = {
                name: "Total",
                children: data
            };
            
            // Get container dimensions
            const container = document.getElementById('sunburstChart');
            const containerWidth = container.offsetWidth;
            const width = Math.min(containerWidth - 40, 800); // Max 800px, with padding
            const height = Math.min(width, 500); // Keep it proportional, max 500px height
            const radius = Math.min(width, height) / 2;
            
            // Create SVG with viewBox for responsiveness
            const svg = d3.select("#sunburstChart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);
            
            // Create partition layout
            const partition = d3.partition()
                .size([2 * Math.PI, radius]);
            
            // Create arc generator
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1);
            
            // Create hierarchy
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);
            
            // Calculate layout
            partition(root);
            
            // Color scale
            const color = d3.scaleOrdinal(d3.schemeSet3);
            
            // Create arcs
            svg.selectAll("path")
                .data(root.descendants())
                .enter().append("path")
                .attr("d", arc)
                .style("fill", d => color(d.data.name))
                .style("stroke", "#fff")
                .style("stroke-width", 2)
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    d3.select(this).style("opacity", 0.8);
                    
                    // Show tooltip
                    const tooltip = d3.select("body").append("div")
                        .attr("class", "chart-tooltip")
                        .style("position", "absolute")
                        .style("padding", "10px")
                        .style("background", "rgba(0,0,0,0.8)")
                        .style("color", "white")
                        .style("border-radius", "5px")
                        .style("pointer-events", "none")
                        .style("opacity", 0)
                        .style("z-index", "1000");
                    
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`${d.data.name}<br/>${d.value ? d.value.toFixed(2) : '0.00'}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).style("opacity", 1);
                    d3.selectAll(".chart-tooltip").remove();
                });
            
            // Add labels for larger segments only
            svg.selectAll("text")
                .data(root.descendants())
                .enter().append("text")
                .attr("transform", d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr("dy", "0.35em")
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .style("fill", "white")
                .style("pointer-events", "none")
                .text(d => {
                    // Only show labels for segments that are big enough
                    const angle = d.x1 - d.x0;
                    return d.depth && angle > 0.1 && d.data.name.length < 10 ? d.data.name : "";
                });
        });
}

function updateStats(month, year) {
    // This would typically fetch from an API endpoint
    // For now, calculating from the category data
    fetch(`/analytics/api/expense-by-category?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.labels.length > 0) {
                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                document.getElementById('totalSpent').textContent = `$${total.toFixed(2)}`;
                
                // Calculate average daily (assuming 30 days)
                const avgDaily = total / 30;
                document.getElementById('avgDaily').textContent = `$${avgDaily.toFixed(2)}`;
                
                // Find top category
                const maxIndex = data.datasets[0].data.indexOf(Math.max(...data.datasets[0].data));
                document.getElementById('topCategory').textContent = data.labels[maxIndex];
                
                // Update transaction count (would need separate API)
                document.getElementById('transactionCount').textContent = data.labels.length;
            } else {
                // No data - show zeros
                document.getElementById('totalSpent').textContent = '$0.00';
                document.getElementById('avgDaily').textContent = '$0.00';
                document.getElementById('topCategory').textContent = 'No data';
                document.getElementById('transactionCount').textContent = '0';
            }
            
            // Generate insights
            generateInsights(data);
        })
        .catch(error => {
            console.error('Error updating stats:', error);
        });
}

function generateInsights(data) {
    const insightsDiv = document.getElementById('insights');
    insightsDiv.innerHTML = '';
    
    if (data.labels && data.labels.length > 0) {
        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
        const maxIndex = data.datasets[0].data.indexOf(Math.max(...data.datasets[0].data));
        const topCategory = data.labels[maxIndex];
        const topAmount = data.datasets[0].data[maxIndex];
        const topPercentage = ((topAmount / total) * 100).toFixed(1);
        
        // Insight 1: Top spending category
        const insight1 = document.createElement('div');
        insight1.className = 'insight-card';
        insight1.innerHTML = `
            <h6><i class="bi bi-exclamation-circle text-warning me-2"></i>Highest Spending Category</h6>
            <p class="mb-0">You spent <strong>$${topAmount.toFixed(2)}</strong> on <strong>${topCategory}</strong>, 
            which is <strong>${topPercentage}%</strong> of your total expenses this month.</p>
        `;
        insightsDiv.appendChild(insight1);
        
        // Insight 2: Spending distribution
        const categoriesOver20Percent = data.labels.filter((label, index) => 
            (data.datasets[0].data[index] / total * 100) > 20
        ).length;
        
        if (categoriesOver20Percent > 1) {
            const insight2 = document.createElement('div');
            insight2.className = 'insight-card';
            insight2.style.borderLeftColor = '#e74c3c';
            insight2.innerHTML = `
                <h6><i class="bi bi-graph-down text-danger me-2"></i>Spending Concentration</h6>
                <p class="mb-0">You have <strong>${categoriesOver20Percent} categories</strong> that each represent 
                more than 20% of your spending. Consider diversifying your budget.</p>
            `;
            insightsDiv.appendChild(insight2);
        }
        
        // Insight 3: Savings opportunity
        if (total > 1000) {
            const savingsTarget = total * 0.1; // 10% savings recommendation
            const insight3 = document.createElement('div');
            insight3.className = 'insight-card';
            insight3.style.borderLeftColor = '#27ae60';
            insight3.innerHTML = `
                <h6><i class="bi bi-piggy-bank text-success me-2"></i>Savings Opportunity</h6>
                <p class="mb-0">By reducing spending by just 10%, you could save <strong>$${savingsTarget.toFixed(2)}</strong> 
                this month. Consider reviewing your ${topCategory} expenses first.</p>
            `;
            insightsDiv.appendChild(insight3);
        }
        
        // Insight 4: Budget recommendation
        const avgPerCategory = total / data.labels.length;
        const categoriesAboveAvg = data.labels.filter((label, index) => 
            data.datasets[0].data[index] > avgPerCategory * 1.5
        );
        
        if (categoriesAboveAvg.length > 0) {
            const insight4 = document.createElement('div');
            insight4.className = 'insight-card';
            insight4.style.borderLeftColor = '#9966FF';
            insight4.innerHTML = `
                <h6><i class="bi bi-calculator text-primary me-2"></i>Budget Alert</h6>
                <p class="mb-0">Categories significantly above average: <strong>${categoriesAboveAvg.join(', ')}</strong>. 
                Consider setting specific budgets for these categories.</p>
            `;
            insightsDiv.appendChild(insight4);
        }
    } else {
        insightsDiv.innerHTML = `
            <div class="insight-card">
                <h6><i class="bi bi-info-circle me-2"></i>No Data Available</h6>
                <p class="mb-0 text-muted">Start adding expenses to see insights and recommendations.</p>
            </div>
        `;
    }
}

// Export functions
function exportChart(chartId) {
    const canvas = document.getElementById(chartId);
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
    link.href = url;
    link.click();
}

function exportData() {
    // This would generate a CSV or PDF report
    alert('Export functionality coming soon! This will generate a comprehensive PDF report of your analytics.');
}

// Hide loading spinners after charts load
setTimeout(() => {
    document.querySelectorAll('.loading-spinner').forEach(el => el.style.display = 'none');
}, 1000);
</script>
{% endblock %}